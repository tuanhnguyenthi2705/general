#!/bin/bash
set -euo pipefail

# --- 1. Kiá»ƒm tra vÃ  yÃªu cáº§u nháº­p FOLDER náº¿u chÆ°a cÃ³ ---
if [[ -z "${FOLDER:-}" ]]; then
  read -p "ğŸ“ Nháº­p sá»‘ thÆ° má»¥c FOLDER (vÃ­ dá»¥: 01, 02, 03...): " FOLDER
  if [[ -z "$FOLDER" ]]; then
    echo "âŒ FOLDER khÃ´ng Ä‘Æ°á»£c Ä‘á»ƒ trá»‘ng! Script dá»«ng láº¡i."
    exit 1
  fi
fi

echo "âœ… Sá»­ dá»¥ng FOLDER: $FOLDER"

USER_NAME=$(logname)
BASE_DIR="/home/$USER_NAME/gensyn/$FOLDER"
SRC_TEMP="$BASE_DIR/temp-data"
DEST_DIR="/root/rl-swarm"
CONFIG_FILE="$DEST_DIR/rgym_exp/config/rg-swarm.yaml"
BOOTNODES_FILE="/home/$USER_NAME/gensyn/run/bootnodes.txt"

# --- 2. Kiá»ƒm tra tá»“n táº¡i cá»§a cÃ¡c thÆ° má»¥c cáº§n thiáº¿t ---
if [[ ! -d "$BASE_DIR" ]]; then
  echo "âŒ ThÆ° má»¥c $BASE_DIR khÃ´ng tá»“n táº¡i!"
  exit 1
fi

if [[ ! -d "$SRC_TEMP" ]]; then
  echo "âŒ ThÆ° má»¥c $SRC_TEMP khÃ´ng tá»“n táº¡i!"
  exit 1
fi

if [[ ! -f "$BOOTNODES_FILE" ]]; then
  echo "âŒ File $BOOTNODES_FILE khÃ´ng tá»“n táº¡i!"
  exit 1
fi

# --- 3. Copy temp-data ---
echo "ğŸ“‚ Copy dá»¯ liá»‡u tá»« $SRC_TEMP Ä‘áº¿n $DEST_DIR/modal-login ..."
cp -r "$SRC_TEMP" "$DEST_DIR/modal-login"

# --- 4. HÃ m chá»n ngáº«u nhiÃªn bootnode vÃ  cáº­p nháº­t vÃ o config ---
update_bootnode() {
  echo "ğŸ² Chá»n bootnode ngáº«u nhiÃªn..."
  
  # Chá»n ngáº«u nhiÃªn má»™t bootnode (bá» qua dÃ²ng trá»‘ng)
  RANDOM_BOOTNODE=$(grep -v '^[[:space:]]*$' "$BOOTNODES_FILE" | shuf -n 1)
  
  if [ -z "$RANDOM_BOOTNODE" ]; then
    echo "âš ï¸ Cáº¢NH BÃO: KhÃ´ng láº¥y Ä‘Æ°á»£c bootnode"
    return 1
  fi
  
  # Backup file config trÆ°á»›c khi sá»­a
  cp "$CONFIG_FILE" "$CONFIG_FILE.backup" 2>/dev/null || true
  
  # Láº¥y bootnode cÅ© trÆ°á»›c khi thay tháº¿
  OLD_BOOTNODE=$(grep -E "^[[:space:]]*-[[:space:]]*'/ip4" "$CONFIG_FILE" 2>/dev/null | head -1 | sed "s/^[[:space:]]*-[[:space:]]*//")
  
  # TÃ¬m vÃ  thay tháº¿ dÃ²ng initial_peers báº±ng bootnode má»›i
  sed -i "/^[[:space:]]*-[[:space:]]*'\/ip4/c\    - '$RANDOM_BOOTNODE'" "$CONFIG_FILE"
  
  echo "ğŸ”„ ÄÃ£ cáº­p nháº­t bootnode:"
  echo "   CÅ©: $OLD_BOOTNODE"
  echo "   Má»›i: $RANDOM_BOOTNODE"
}

# --- 5. HÃ m cháº¡y 1 vÃ²ng khá»Ÿi Ä‘á»™ng - kiá»ƒm tra - dá»«ng - di chuyá»ƒn ---
run_cycle() {
  local PEM_SUFFIX=$1
  
  update_bootnode
  
  echo "ğŸ”„ Khá»Ÿi Ä‘á»™ng láº¡i rl-swarm..."
  systemctl restart rl-swarm
  
  echo "â³ Äang chá» file swarm.pem xuáº¥t hiá»‡n..."
  SRC_PEM="$DEST_DIR/swarm.pem"
  
  # Chá» tá»‘i Ä‘a 5 phÃºt (60 láº§n x 5 giÃ¢y)
  COUNTER=0
  while true; do
    if [[ -f "$SRC_PEM" ]]; then
      echo "âœ… PhÃ¡t hiá»‡n swarm.pem â€” dá»«ng rl-swarm..."
      systemctl stop rl-swarm
      break
    fi
    
    COUNTER=$((COUNTER + 1))
    if [ $COUNTER -gt 60 ]; then
      echo "âš ï¸ TIMEOUT: Chá» quÃ¡ lÃ¢u, bá» qua vÃ²ng nÃ y"
      systemctl stop rl-swarm
      return 1
    fi
    
    sleep 5
  done
  
  # --- Di chuyá»ƒn swarm.pem ---
  DEST_PEM="$BASE_DIR/swarm.pem.$PEM_SUFFIX"
  
  if [[ -f "$SRC_PEM" ]]; then
    echo "ğŸ“¦ Di chuyá»ƒn $SRC_PEM â†’ $DEST_PEM"
    mv "$SRC_PEM" "$DEST_PEM"
    echo "âœ… VÃ²ng $PEM_SUFFIX hoÃ n táº¥t"
  else
    echo "âš ï¸ KhÃ´ng tÃ¬m tháº¥y $SRC_PEM!"
    return 1
  fi
  
  echo ""
}

# --- 6. Cháº¡y 8 vÃ²ng (tá»« 8 Ä‘áº¿n 15) ---
echo "ğŸš€ Báº¯t Ä‘áº§u cháº¡y 8 vÃ²ng Ä‘á»ƒ táº¡o swarm.pem.8 Ä‘áº¿n swarm.pem.15"
echo ""

SUCCESS_COUNT=0
FAIL_COUNT=0

for i in {8..15}; do
  echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
  echo "ğŸ”¢ VÃ²ng $((i-7))/8 - Táº¡o swarm.pem.$i"
  echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
  
  if run_cycle $i; then
    SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
  else
    FAIL_COUNT=$((FAIL_COUNT + 1))
    echo "âŒ VÃ²ng $i tháº¥t báº¡i"
    echo ""
  fi
done

echo ""
echo "ğŸ¯ âœ… HOÃ€N Táº¤T"
echo "   ThÃ nh cÃ´ng: $SUCCESS_COUNT/8"
echo "   Tháº¥t báº¡i: $FAIL_COUNT/8"
echo "ğŸ“ Vá»‹ trÃ­: $BASE_DIR/"
echo "âœ¨ Folder: $FOLDER"
