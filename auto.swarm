#!/bin/bash
set -euo pipefail

# --- 1. Kiá»ƒm tra vÃ  yÃªu cáº§u nháº­p FOLDER náº¿u chÆ°a cÃ³ ---
if [[ -z "${FOLDER:-}" ]]; then
  read -p "ğŸ“ Nháº­p sá»‘ thÆ° má»¥c FOLDER (vÃ­ dá»¥: 01, 02, 03...): " FOLDER
  if [[ -z "$FOLDER" ]]; then
    echo "âŒ FOLDER khÃ´ng Ä‘Æ°á»£c Ä‘á»ƒ trá»‘ng! Script dá»«ng láº¡i."
    exit 1
  fi
fi

echo "âœ… Sá»­ dá»¥ng FOLDER: $FOLDER"

USER_NAME=$(logname)
BASE_DIR="/home/$USER_NAME/gensyn/$FOLDER"
SRC_TEMP="$BASE_DIR/temp-data"
DEST_DIR="/root/rl-swarm"
CONFIG_FILE="$DEST_DIR/rgym_exp/config/rg-swarm.yaml"
BOOTNODES_FILE="/home/$USER_NAME/gensyn/run/bootnodes.txt"

# --- 2. Kiá»ƒm tra tá»“n táº¡i cá»§a cÃ¡c thÆ° má»¥c cáº§n thiáº¿t ---
if [[ ! -d "$BASE_DIR" ]]; then
  echo "âŒ ThÆ° má»¥c $BASE_DIR khÃ´ng tá»“n táº¡i!"
  exit 1
fi

if [[ ! -d "$SRC_TEMP" ]]; then
  echo "âŒ ThÆ° má»¥c $SRC_TEMP khÃ´ng tá»“n táº¡i!"
  exit 1
fi

# --- 3. Copy temp-data ---
echo "ğŸ“‚ Copy dá»¯ liá»‡u tá»« $SRC_TEMP Ä‘áº¿n $DEST_DIR/modal-login ..."
cp -r "$SRC_TEMP" "$DEST_DIR/modal-login"

# --- 4. HÃ m chá»n ngáº«u nhiÃªn bootnode vÃ  cáº­p nháº­t vÃ o config ---
update_bootnode() {
  # Kiá»ƒm tra file bootnodes cÃ³ tá»“n táº¡i khÃ´ng
  if [ ! -f "$BOOTNODES_FILE" ]; then
    echo "âš ï¸ Cáº¢NH BÃO: KhÃ´ng tÃ¬m tháº¥y file $BOOTNODES_FILE - giá»¯ nguyÃªn giÃ¡ trá»‹ cÅ©"
    return
  fi
  
  # Kiá»ƒm tra file cÃ³ rá»—ng khÃ´ng
  if [ ! -s "$BOOTNODES_FILE" ]; then
    echo "âš ï¸ Cáº¢NH BÃO: File bootnode rá»—ng, dÃ¹ng bootnode cÅ©"
    return
  fi
  
  # Láº¥y ngáº«u nhiÃªn má»™t dÃ²ng tá»« file bootnodes.txt (bá» qua dÃ²ng trá»‘ng)
  RANDOM_BOOTNODE=$(grep -v '^[[:space:]]*$' "$BOOTNODES_FILE" | shuf -n 1)
  
  if [ -z "$RANDOM_BOOTNODE" ]; then
    echo "âš ï¸ Cáº¢NH BÃO: KhÃ´ng láº¥y Ä‘Æ°á»£c bootnode, dÃ¹ng bootnode cÅ©"
    return
  fi
  
  # Backup file config trÆ°á»›c khi sá»­a
  cp "$CONFIG_FILE" "$CONFIG_FILE.backup"
  
  # Láº¥y bootnode cÅ© trÆ°á»›c khi thay tháº¿
  OLD_BOOTNODE=$(grep -E "^[[:space:]]*-[[:space:]]*'/ip4" "$CONFIG_FILE" | head -1 | sed "s/^[[:space:]]*-[[:space:]]*//")
  
  # TÃ¬m vÃ  thay tháº¿ dÃ²ng initial_peers báº±ng bootnode má»›i
  sed -i "/^[[:space:]]*-[[:space:]]*'\/ip4/c\    - '$RANDOM_BOOTNODE'" "$CONFIG_FILE"
  
  echo "ğŸ”„ ÄÃ£ cáº­p nháº­t bootnode:"
  echo "   CÅ©: $OLD_BOOTNODE"
  echo "   Má»›i: $RANDOM_BOOTNODE"
}

# --- 5. HÃ m cháº¡y 1 vÃ²ng khá»Ÿi Ä‘á»™ng - kiá»ƒm tra - dá»«ng - di chuyá»ƒn ---
run_cycle() {
  local PEM_SUFFIX=$1
  
  echo "ğŸ² Chá»n bootnode ngáº«u nhiÃªn..."
  update_bootnode
  
  echo "ğŸ”„ Khá»Ÿi Ä‘á»™ng láº¡i rl-swarm..."
  systemctl restart rl-swarm
  
  echo "â³ Äang chá» file swarm.pem xuáº¥t hiá»‡n..."
  SRC_PEM="$DEST_DIR/swarm.pem"
  
  while true; do
    if [[ -f "$SRC_PEM" ]]; then
      echo "âœ… PhÃ¡t hiá»‡n swarm.pem â€” dá»«ng rl-swarm..."
      systemctl stop rl-swarm
      break
    fi
    sleep 5
  done
  
  # --- Di chuyá»ƒn swarm.pem ---
  DEST_PEM="$BASE_DIR/swarm.pem.$PEM_SUFFIX"
  
  if [[ -f "$SRC_PEM" ]]; then
    echo "ğŸ“¦ Di chuyá»ƒn $SRC_PEM â†’ $DEST_PEM"
    mv "$SRC_PEM" "$DEST_PEM"
  else
    echo "âš ï¸ KhÃ´ng tÃ¬m tháº¥y $SRC_PEM!"
  fi
  
  echo "âœ… VÃ²ng $PEM_SUFFIX hoÃ n táº¥t"
  echo ""
}

# --- 6. Cháº¡y 8 vÃ²ng (tá»« 8 Ä‘áº¿n 15) ---
echo "ğŸš€ Báº¯t Ä‘áº§u cháº¡y 8 vÃ²ng Ä‘á»ƒ táº¡o swarm.pem.8 Ä‘áº¿n swarm.pem.15"
echo ""

for i in {8..15}; do
  echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
  echo "ğŸ”¢ VÃ²ng $((i-7))/8 - Táº¡o swarm.pem.$i"
  echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
  run_cycle $i
done

echo ""
echo "ğŸ¯ âœ… HOÃ€N Táº¤T â€” ÄÃ£ táº¡o 8 file swarm.pem tá»« swarm.pem.8 Ä‘áº¿n swarm.pem.15"
echo "ğŸ“ Vá»‹ trÃ­: $BASE_DIR/"
echo "âœ¨ Folder: $FOLDER"
